#!/bin/bash
# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º: —Å–∫—Ä–∏–ø—Ç –ø—Ä–µ—Ä–≤–µ—Ç—Å—è –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ.
set -e

# --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞ ---
# LOG –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–∑–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç)
LOG() { echo -e "\e[1;32m[INFO]\e[0m $*"; }
# ERR –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö (–∫—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç), –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç
ERR() { echo -e "\e[1;31m[ERROR]\e[0m $*" >&2; exit 1; }

# --- –ù–∞—á–∞–ª–æ —Å–∫—Ä–∏–ø—Ç–∞ ---

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –æ—Ç –∏–º–µ–Ω–∏ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (root)
if [[ $EUID -ne 0 ]]; then
   ERR "–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –æ—Ç –∏–º–µ–Ω–∏ root –∏–ª–∏ —á–µ—Ä–µ–∑ sudo."
fi

LOG "–®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–∑–æ–≤—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
apt-get update -y
# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞–∫–µ—Ç—ã, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –∏ –¥–ª—è Docker
apt-get install -y ca-certificates curl gnupg lsb-release iptables apt-transport-https --no-install-recommends

# 2. –í–ê–ñ–ù–´–ô –®–ê–ì: –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º iptables –≤ —Ä–µ–∂–∏–º legacy –ü–ï–†–ï–î —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π Docker
LOG "–®–∞–≥ 2: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ iptables –≤ —Ä–µ–∂–∏–º legacy –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏..."
update-alternatives --set iptables /usr/sbin/iptables-legacy
update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy
# –≠—Ç–æ—Ç —à–∞–≥ –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ Docker –Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö, –≤–∫–ª—é—á–∞—è Wiren Board.

LOG "–®–∞–≥ 3: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ GPG –∫–ª—é—á–∞ –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Docker..."
# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∫–ª—é—á–µ–π, –µ—Å–ª–∏ –µ–µ –Ω–µ—Ç
install -m 0755 -d /etc/apt/keyrings
# –°–∫–∞—á–∏–≤–∞–µ–º –∫–ª—é—á Docker –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ
curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
# –î–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª –∫–ª—é—á–∞
chmod a+r /etc/apt/keyrings/docker.asc

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ –∫–æ–¥–æ–≤–æ–µ –∏–º—è –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞
ARCH=$(dpkg --print-architecture)
CODENAME=$(lsb_release -cs)

# –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π Docker –≤ —Å–∏—Å—Ç–µ–º—É
echo \
  "deb [arch=$ARCH signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian \
  $CODENAME stable" > /etc/apt/sources.list.d/docker.list

LOG "–®–∞–≥ 4: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker Engine..."
apt-get update -y
# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞–∫–µ—Ç—ã Docker
apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin --no-install-recommends

LOG "–®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ Docker..."
# –î–∞–µ–º —Å–∏—Å—Ç–µ–º–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã —Å–ª—É–∂–±–∞ –∑–∞–ø—É—Å—Ç–∏–ª–∞—Å—å
sleep 5
# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–ª—É–∂–±–∞ Docker –∞–∫—Ç–∏–≤–Ω–∞
if ! systemctl is-active --quiet docker; then
    LOG "–°–ª—É–∂–±–∞ Docker –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–∞—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –ø—Ä–æ–±—É—é –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é..."
    systemctl restart docker
    sleep 5
fi

LOG "–®–∞–≥ 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Docker..."
# –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä hello-world
if docker run --rm hello-world >/dev/null 2>&1; then
  LOG "üéâ Docker —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç!"
else
  # –ï—Å–ª–∏ —Ç–µ—Å—Ç –Ω–µ –ø—Ä–æ—à–µ–ª, –≤—ã–≤–æ–¥–∏–º –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
  ERR "Docker —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–æ —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —Å–ª—É–∂–±—ã: systemctl status docker.service"
fi

LOG "–ì–æ—Ç–æ–≤–æ. –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å docker –∏ docker compose."
