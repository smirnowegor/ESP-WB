# ESP-WB — Wiren Board + ESPHome integration

## Что внутри (файлы и назначение)

- `espWB_MAP12E.yaml` — основная ESPHome прошивка-конфигурация для интеграции MAP12E через UART/Modbus. Ключевые блоки:
	- `esphome` / `name` / `build_path` — метаданные и путь сборки.
	- `esp32` — целевая плата и фреймворк (ESP-IDF в проекте).
	- `wifi`, `api`, `ota`, `logger`, `captive_portal` — стандартные сервисы ESPHome.
	- `uart` / `modbus` / `modbus_controller` — настройка Modbus по UART (скорость 9600, паритет/стоп-биты) и адрес устройства MAP12E.
	- `sensor` — большой набор Modbus-сенсоров: напряжения, токи, активная мощность и счётчики энергии; также присутствуют `template` сенсоры для тарифных корзин (T1..T4) с `state_class: total_increasing` для корректной работы в Home Assistant.
	- `on_boot` — публикация восстановленных значений тарифных `template`-сенсоров после перезагрузки (восстановление сохранённых глобалов).
	- Фильтры и `on_value`-обработчики (например, вызов `process_energy_update`) обеспечивают агрегацию/обработку значений при появлении новых показаний.

	Этот файл — основной источник логики преобразования Modbus-регистров MAP12E в сущности Home Assistant и должен быть подстроен под вашу карту регистров (адреса и множители).

- `espWB_MAP12E_noTariff.yaml` — облегчённый вариант прошивки без шаблонных тарифных сенсоров: оставляет только базовые Modbus-датчики и полезен, если тарифный расчёт выполняется на стороне WB/HA.

- `espHomeWB.yaml` — пример сервиса/стековой конфигурации для запуска контейнера `esphome`:
	- `setup_esphome` — одноразовый контейнер для создания директорий и выставления прав в `/mnt/data/udobnidom/esphome`.
	- `esphome` — основной контейнер `ghcr.io/esphome/esphome:stable` с пробросом устройств `/dev`, `build`/`data`/`.platformio` на `/mnt/data` для сохранения кэша и сборок вне контейнера.
	- Полезно для сборки прошивок, OTA и команд `esphome run` в изолированном окружении.

- `homeassistantWB.yaml` — пример запуска Home Assistant в контейнере:
	- `setup_homeassistant` — подготовка директорий в `/mnt/data/udobnidom/homeassistant`.
	- `homeassistant` — контейнер `homeassistant/home-assistant:latest` с монтированием конфигурации и сокета Docker (опционально), полезен для развёртывания HA на WB-хосте.

- `WB-MAP12Efw2_145_tarif.js` — скрипт правил для Wiren Board (Rules Engine):
	- Создаёт виртуальные устройства `map12e_tariffs` (настройка тарифов) и `map12e_data` (агрегированные значения и управляющие поля).
	- Реализует парсинг временных границ тарифов, валидацию последовательностей (функции `parseTimeHHMM`, `validateTimeRanges`).
	- Функция `getTariffInfo` определяет текущий тариф по времени (1/2/3 тарифные схемы).
	- Главный rule `map12e_data_aggregator` выполняется по cron и: читает суммарные значения с счётчика (`readChTotalAP`), вычисляет дельту, распределяет дельту по текущему тарифу, поддерживает ручной ввод (manual overwrite) и защиту от больших скачков.
	- Инициализация устанавливает `chXX_last_total` и индикатор статуса; в скрипте есть fallback-логика при ошибках конфигурации.

- `fastDockerWb.sh` — скрипт «всё-в-одном» для установки и настройки Docker/Containerd на Wiren Board:
	- Удаляет конфликтующие пакеты, устанавливает зависимости, добавляет официальный репозиторий Docker.
	- Позволяет выбрать целевой раздел (рекомендуется `/mnt/data`) и переносит данные (`rsync`) в новое `data-root`.
	- Создаёт символьные ссылки при необходимости, настраивает `/etc/docker/daemon.json` с ограничениями логов (`max-size`, `max-file`) и перезапускает сервисы.
	- Содержит проверки прав, свободного места, inode, и interactive-подтверждения при удалении старых данных.

- `fastPortainerWB.sh`, `fastZ2MWB.sh`, `duplicatiFastWB.sh` — вспомогательные скрипты развертывания Portainer, Zigbee2MQTT и Duplicati соответственно; используют подходы работы с `/mnt/data` и настройкой контейнеров под WB.

- `wudWB.yaml` — docker-compose snippet для запуска WUD (Watchdog/Updater Dashboard):
	- Экспонирует UI на порту 3006, настраивает интеграцию через MQTT (`WUD_TRIGGER_MQTT_MOSQUITTO_URL`) и подключение к Docker через сокет.

- `WB-MDM3/` — вспомогательная директория с ресурсами и прошивками (проверьте содержимое для деталей).

---

## Контакты и поддержка

Автор: Егор (smirnowegor). Для связи и срочных вопросов используйте Telegram: https://t.me/godisblind

Поддержка / донаты:

- https://dzen.ru/id/5e32d0969929ba40059b5892?donate=true
- https://donate.stream/yoomoney410013774736621

---

Если нужно, сейчас могу:
- Прописать детальный «Разбор `espWB_MAP12E.yaml` по блокам» со списком регистров и пояснениями (с учётом содержимого файла);
- Сгенерировать единый `docker-compose.yml`, объединяющий `espHomeWB.yaml`, `homeassistantWB.yaml` и `wudWB.yaml` в одну сеть и с общими volume;
- Подготовить PR с изменениями README.

Напишите, какой шаг делаем следующим.
