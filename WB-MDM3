# Documentation https://wirenboard.com/wiki/WB-MDM3_230V_Modbus_Dimmer

substitutions:
  dev_name: wb3
  modbus_addr: 211
  debounce: 50ms
  short_click_max: 500ms
  long_click_min: 1s

esphome:
  name: ${dev_name}
  friendly_name: "WB-MDM3 Dimmer"

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: esp-idf

logger:
  level: VERY_VERBOSE
  baud_rate: 115200

api:
  encryption:
    key: "YOUR KEY"

ota:
  platform: esphome
  password: "YOUR KEY"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "${dev_name} Fallback Hotspot"
    password: !secret wifi_password

captive_portal:

uart:
  id: modbus_uart_bus
  tx_pin: GPIO17
  rx_pin: GPIO18
  baud_rate: 9600
  data_bits: 8
  parity: NONE
  stop_bits: 1

modbus:
  id: modbus_bus
  uart_id: modbus_uart_bus
  send_wait_time: 50ms

modbus_controller:
  - id: wb_mdm3
    modbus_id: modbus_bus
    address: ${modbus_addr}
    update_interval: 2s
    setup_priority: -10

# ----------------------
# Switches (outputs control via Modbus coils)
# ----------------------
switch:
  - platform: modbus_controller
    id: ch1_on_off
    modbus_controller_id: wb_mdm3
    register_type: coil
    address: 0
    name: "Канал 1 ВКЛ/ВЫКЛ"
    internal: true
  - platform: modbus_controller
    id: ch2_on_off
    modbus_controller_id: wb_mdm3
    register_type: coil
    address: 1
    name: "Канал 2 ВКЛ/ВЫКЛ"
    internal: true
  - platform: modbus_controller
    id: ch3_on_off
    modbus_controller_id: wb_mdm3
    register_type: coil
    address: 2
    name: "Канал 3 ВКЛ/ВЫКЛ"
    internal: true

# ----------------------
# Outputs (template outputs used by lights)
# ----------------------
output:
  - platform: template
    id: ch1_output
    type: float
    write_action:
      - lambda: |-
          if (state <= 0.0f) {
            id(ch1_on_off).turn_off();
          } else {
            id(ch1_on_off).turn_on();
            auto call = id(ch1_brightness).make_call();
            call.set_value(state * 100.0f);
            call.perform();
          }
  - platform: template
    id: ch2_output
    type: float
    write_action:
      - lambda: |-
          if (state <= 0.0f) {
            id(ch2_on_off).turn_off();
          } else {
            id(ch2_on_off).turn_on();
            auto call = id(ch2_brightness).make_call();
            call.set_value(state * 100.0f);
            call.perform();
          }
  - platform: template
    id: ch3_output
    type: float
    write_action:
      - lambda: |-
          if (state <= 0.0f) {
            id(ch3_on_off).turn_off();
          } else {
            id(ch3_on_off).turn_on();
            auto call = id(ch3_brightness).make_call();
            call.set_value(state * 100.0f);
            call.perform();
          }

# ----------------------
# Lights (monochromatic channels)
# ----------------------
light:
  - platform: monochromatic
    name: "Канал 1 Свет"
    id: ch1_light
    output: ch1_output
    default_transition_length: 0s
    restore_mode: RESTORE_DEFAULT_OFF
    on_state:
      - number.set:
          id: ch1_brightness
          value: !lambda "return id(ch1_light).current_values.get_brightness() * 100.0f;"
  - platform: monochromatic
    name: "Канал 2 Свет"
    id: ch2_light
    output: ch2_output
    default_transition_length: 0s
    restore_mode: RESTORE_DEFAULT_OFF
    on_state:
      - number.set:
          id: ch2_brightness
          value: !lambda "return id(ch2_light).current_values.get_brightness() * 100.0f;"
  - platform: monochromatic
    name: "Канал 3 Свет"
    id: ch3_light
    output: ch3_output
    default_transition_length: 0s
    restore_mode: RESTORE_DEFAULT_OFF
    on_state:
      - number.set:
          id: ch3_brightness
          value: !lambda "return id(ch3_light).current_values.get_brightness() * 100.0f;"

# ----------------------
# Numbers (brightness, thresholds, speeds, power-on brightness, safe brightness)
# ----------------------
number:
  - platform: modbus_controller
    id: ch1_brightness
    modbus_controller_id: wb_mdm3
    register_type: holding
    address: 0
    value_type: U_WORD
    min_value: 0
    max_value: 100
    step: 1
    internal: true
    name: "Канал 1 Яркость"
    mode: box
  - platform: modbus_controller
    id: ch1_dim_low_threshold
    modbus_controller_id: wb_mdm3
    name: "К1 Порог мин (мкс)"
    address: 70
    register_type: holding
    value_type: U_WORD
    min_value: 0
    max_value: 9999
    step: 100
    mode: box
  - platform: modbus_controller
    id: ch1_dim_high_threshold
    modbus_controller_id: wb_mdm3
    name: "К1 Порог макс (мкс)"
    address: 80
    register_type: holding
    value_type: U_WORD
    min_value: 0
    max_value: 9999
    step: 100
    mode: box
  - platform: modbus_controller
    id: ch1_ramp_up_speed
    modbus_controller_id: wb_mdm3
    name: "К1 Скорость нарастания (мс)"
    address: 140
    register_type: holding
    value_type: U_WORD
    min_value: 0
    max_value: 500
    step: 10
    mode: box
  - platform: modbus_controller
    id: ch1_ramp_down_speed
    modbus_controller_id: wb_mdm3
    name: "К1 Скорость затухания (мс)"
    address: 150
    register_type: holding
    value_type: U_WORD
    min_value: 0
    max_value: 500
    step: 10
    mode: box
  - platform: modbus_controller
    id: ch1_safe_brightness
    modbus_controller_id: wb_mdm3
    name: "К1 Яркость аварии"
    address: 656
    register_type: holding
    value_type: U_WORD
    min_value: 1
    max_value: 100
    step: 1
    mode: box
  - platform: modbus_controller
    id: ch1_power_on_brightness
    modbus_controller_id: wb_mdm3
    name: "К1 Яркость при включении"
    address: 672
    register_type: holding
    value_type: U_WORD
    min_value: 1
    max_value: 100
    step: 1
    mode: box

  - platform: modbus_controller
    id: ch2_brightness
    modbus_controller_id: wb_mdm3
    register_type: holding
    address: 1
    value_type: U_WORD
    min_value: 0
    max_value: 100
    step: 1
    internal: true
    name: "Канал 2 Яркость"
    mode: box
  - platform: modbus_controller
    id: ch2_dim_low_threshold
    modbus_controller_id: wb_mdm3
    name: "К2 Порог мин (мкс)"
    address: 71
    register_type: holding
    value_type: U_WORD
    min_value: 0
    max_value: 9999
    step: 100
    mode: box
  - platform: modbus_controller
    id: ch2_dim_high_threshold
    modbus_controller_id: wb_mdm3
    name: "К2 Порог макс (мкс)"
    address: 81
    register_type: holding
    value_type: U_WORD
    min_value: 0
    max_value: 9999
    step: 100
    mode: box
  - platform: modbus_controller
    id: ch2_ramp_up_speed
    modbus_controller_id: wb_mdm3
    name: "К2 Скорость нарастания (мс)"
    address: 141
    register_type: holding
    value_type: U_WORD
    min_value: 0
    max_value: 500
    step: 10
    mode: box
  - platform: modbus_controller
    id: ch2_ramp_down_speed
    modbus_controller_id: wb_mdm3
    name: "К2 Скорость затухания (мс)"
    address: 151
    register_type: holding
    value_type: U_WORD
    min_value: 0
    max_value: 500
    step: 10
    mode: box
  - platform: modbus_controller
    id: ch2_safe_brightness
    modbus_controller_id: wb_mdm3
    name: "К2 Яркость аварии"
    address: 657
    register_type: holding
    value_type: U_WORD
    min_value: 1
    max_value: 100
    step: 1
    mode: box
  - platform: modbus_controller
    id: ch2_power_on_brightness
    modbus_controller_id: wb_mdm3
    name: "К2 Яркость при включении"
    address: 673
    register_type: holding
    value_type: U_WORD
    min_value: 1
    max_value: 100
    step: 1
    mode: box

  - platform: modbus_controller
    id: ch3_brightness
    modbus_controller_id: wb_mdm3
    register_type: holding
    address: 2
    value_type: U_WORD
    min_value: 0
    max_value: 100
    step: 1
    internal: true
    name: "Канал 3 Яркость"
    mode: box
  - platform: modbus_controller
    id: ch3_dim_low_threshold
    modbus_controller_id: wb_mdm3
    name: "К3 Порог мин (мкс)"
    address: 72
    register_type: holding
    value_type: U_WORD
    min_value: 0
    max_value: 9999
    step: 100
    mode: box
  - platform: modbus_controller
    id: ch3_dim_high_threshold
    modbus_controller_id: wb_mdm3
    name: "К3 Порог макс (мкс)"
    address: 82
    register_type: holding
    value_type: U_WORD
    min_value: 0
    max_value: 9999
    step: 100
    mode: box
  - platform: modbus_controller
    id: ch3_ramp_up_speed
    modbus_controller_id: wb_mdm3
    name: "К3 Скорость нарастания (мс)"
    address: 142
    register_type: holding
    value_type: U_WORD
    min_value: 0
    max_value: 500
    step: 10
    mode: box
  - platform: modbus_controller
    id: ch3_ramp_down_speed
    modbus_controller_id: wb_mdm3
    name: "К3 Скорость затухания (мс)"
    address: 152
    register_type: holding
    value_type: U_WORD
    min_value: 0
    max_value: 500
    step: 10
    mode: box
  - platform: modbus_controller
    id: ch3_safe_brightness
    modbus_controller_id: wb_mdm3
    name: "К3 Яркость аварии"
    address: 658
    register_type: holding
    value_type: U_WORD
    min_value: 1
    max_value: 100
    step: 1
    mode: box
  - platform: modbus_controller
    id: ch3_power_on_brightness
    modbus_controller_id: wb_mdm3
    name: "К3 Яркость при включении"
    address: 674
    register_type: holding
    value_type: U_WORD
    min_value: 1
    max_value: 100
    step: 1
    mode: box

  - platform: template
    name: "Счетчик замыканий Вход 1"
    id: input1_counter
    restore_value: true
    min_value: 0
    max_value: 1000000000
    step: 1
    optimistic: true
    mode: box

  # Input long press, double click, debounce times
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 1 Long Press Time (ms)"
    id: input1_long_press_time
    address: 1100
    register_type: holding
    value_type: U_WORD
    min_value: 500
    max_value: 5000
    step: 100
    mode: box
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 2 Long Press Time (ms)"
    id: input2_long_press_time
    address: 1101
    register_type: holding
    value_type: U_WORD
    min_value: 500
    max_value: 5000
    step: 100
    mode: box
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 3 Long Press Time (ms)"
    id: input3_long_press_time
    address: 1102
    register_type: holding
    value_type: U_WORD
    min_value: 500
    max_value: 5000
    step: 100
    mode: box
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 4 Long Press Time (ms)"
    id: input4_long_press_time
    address: 1103
    register_type: holding
    value_type: U_WORD
    min_value: 500
    max_value: 5000
    step: 100
    mode: box
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 5 Long Press Time (ms)"
    id: input5_long_press_time
    address: 1104
    register_type: holding
    value_type: U_WORD
    min_value: 500
    max_value: 5000
    step: 100
    mode: box
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 6 Long Press Time (ms)"
    id: input6_long_press_time
    address: 1105
    register_type: holding
    value_type: U_WORD
    min_value: 500
    max_value: 5000
    step: 100
    mode: box

  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 1 Double Click Time (ms)"
    id: input1_double_click_time
    address: 1140
    register_type: holding
    value_type: U_WORD
    min_value: 0
    max_value: 2000
    step: 10
    mode: box
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 2 Double Click Time (ms)"
    id: input2_double_click_time
    address: 1141
    register_type: holding
    value_type: U_WORD
    min_value: 0
    max_value: 2000
    step: 10
    mode: box
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 3 Double Click Time (ms)"
    id: input3_double_click_time
    address: 1142
    register_type: holding
    value_type: U_WORD
    min_value: 0
    max_value: 2000
    step: 10
    mode: box
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 4 Double Click Time (ms)"
    id: input4_double_click_time
    address: 1143
    register_type: holding
    value_type: U_WORD
    min_value: 0
    max_value: 2000
    step: 10
    mode: box
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 5 Double Click Time (ms)"
    id: input5_double_click_time
    address: 1144
    register_type: holding
    value_type: U_WORD
    min_value: 0
    max_value: 2000
    step: 10
    mode: box
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 6 Double Click Time (ms)"
    id: input6_double_click_time
    address: 1145
    register_type: holding
    value_type: U_WORD
    min_value: 0
    max_value: 2000
    step: 10
    mode: box

  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 1 Debounce Time (ms)"
    id: input1_debounce_time
    address: 1160
    register_type: holding
    value_type: U_WORD
    min_value: 0
    max_value: 2000
    step: 1
    mode: box
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 2 Debounce Time (ms)"
    id: input2_debounce_time
    address: 1161
    register_type: holding
    value_type: U_WORD
    min_value: 0
    max_value: 2000
    step: 1
    mode: box
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 3 Debounce Time (ms)"
    id: input3_debounce_time
    address: 1162
    register_type: holding
    value_type: U_WORD
    min_value: 0
    max_value: 2000
    step: 1
    mode: box
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 4 Debounce Time (ms)"
    id: input4_debounce_time
    address: 1163
    register_type: holding
    value_type: U_WORD
    min_value: 0
    max_value: 2000
    step: 1
    mode: box
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 5 Debounce Time (ms)"
    id: input5_debounce_time
    address: 1164
    register_type: holding
    value_type: U_WORD
    min_value: 0
    max_value: 2000
    step: 1
    mode: box
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 6 Debounce Time (ms)"
    id: input6_debounce_time
    address: 1165
    register_type: holding
    value_type: U_WORD
    min_value: 0
    max_value: 2000
    step: 1
    mode: box

# ----------------------
# Selects (dimming curves, modes, and many input action mappings)
# ----------------------
select:
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "К1 Кривая диммирования"
    id: ch1_dimming_curve
    address: 50
    optionsmap:
      "Светодиодная/Накаливания": 0
      "Линейная": 1
      "Ключевой режим": 2
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "К1 Режим диммирования"
    id: ch1_dimming_mode
    address: 60
    optionsmap:
      "По переднему фронту": 0
      "По заднему фронту": 1
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "К2 Кривая диммирования"
    id: ch2_dimming_curve
    address: 51
    optionsmap:
      "Светодиодная/Накаливания": 0
      "Линейная": 1
      "Ключевой режим": 2
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "К2 Режим диммирования"
    id: ch2_dimming_mode
    address: 61
    optionsmap:
      "По переднему фронту": 0
      "По заднему фронту": 1
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "К3 Кривая диммирования"
    id: ch3_dimming_curve
    address: 52
    optionsmap:
      "Светодиодная/Накаливания": 0
      "Линейная": 1
      "Ключевой режим": 2
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "К3 Режим диммирования"
    id: ch3_dimming_mode
    address: 62
    optionsmap:
      "По переднему фронту": 0
      "По заднему фронту": 1

  # Input modes
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 1 Mode"
    id: input1_mode
    address: 416
    optionsmap:
      "Button": 0
      "Latched Switch": 1
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 2 Mode"
    id: input2_mode
    address: 417
    optionsmap:
      "Button": 0
      "Latched Switch": 1
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 3 Mode"
    id: input3_mode
    address: 418
    optionsmap:
      "Button": 0
      "Latched Switch": 1
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 4 Mode"
    id: input4_mode
    address: 419
    optionsmap:
      "Button": 0
      "Latched Switch": 1
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 5 Mode"
    id: input5_mode
    address: 420
    optionsmap:
      "Button": 0
      "Latched Switch": 1
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 6 Mode"
    id: input6_mode
    address: 421
    optionsmap:
      "Button": 0
      "Latched Switch": 1

  # Latch OFF actions and ON actions
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 1 Action (OFF)"
    id: input1_latch_off_action
    address: 736
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 2 Action (OFF)"
    id: input2_latch_off_action
    address: 737
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 3 Action (OFF)"
    id: input3_latch_off_action
    address: 738
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 4 Action (OFF)"
    id: input4_latch_off_action
    address: 739
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 5 Action (OFF)"
    id: input5_latch_off_action
    address: 740
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 6 Action (OFF)"
    id: input6_latch_off_action
    address: 741
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2

  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 1 Action (ON)"
    id: input1_latch_on_action
    address: 752
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 2 Action (ON)"
    id: input2_latch_on_action
    address: 753
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 3 Action (ON)"
    id: input3_latch_on_action
    address: 754
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 4 Action (ON)"
    id: input4_latch_on_action
    address: 755
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 5 Action (ON)"
    id: input5_latch_on_action
    address: 756
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 6 Action (ON)"
    id: input6_latch_on_action
    address: 757
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2

  # Latch OFF/ON target outputs
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 1 Output (OFF)"
    id: input1_latch_off_output
    address: 704
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 2 Output (OFF)"
    id: input2_latch_off_output
    address: 705
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 3 Output (OFF)"
    id: input3_latch_off_output
    address: 706
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 4 Output (OFF)"
    id: input4_latch_off_output
    address: 707
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 5 Output (OFF)"
    id: input5_latch_off_output
    address: 708
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 6 Output (OFF)"
    id: input6_latch_off_output
    address: 709
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100

  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 1 Output (ON)"
    id: input1_latch_on_output
    address: 720
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 2 Output (ON)"
    id: input2_latch_on_output
    address: 721
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 3 Output (ON)"
    id: input3_latch_on_output
    address: 722
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 4 Output (ON)"
    id: input4_latch_on_output
    address: 723
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 5 Output (ON)"
    id: input5_latch_on_output
    address: 724
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 6 Output (ON)"
    id: input6_latch_on_output
    address: 725
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100

  # Short/Long/Double/Short+Long Actions
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 1 Action (Short)"
    id: input1_short_action
    address: 832
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
      "Decrease Level": 3
      "Increase Level": 4
      "Increase/Decrease Level": 5
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 2 Action (Short)"
    id: input2_short_action
    address: 833
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
      "Decrease Level": 3
      "Increase Level": 4
      "Increase/Decrease Level": 5
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 3 Action (Short)"
    id: input3_short_action
    address: 834
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
      "Decrease Level": 3
      "Increase Level": 4
      "Increase/Decrease Level": 5
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 4 Action (Short)"
    id: input4_short_action
    address: 835
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
      "Decrease Level": 3
      "Increase Level": 4
      "Increase/Decrease Level": 5
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 5 Action (Short)"
    id: input5_short_action
    address: 836
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
      "Decrease Level": 3
      "Increase Level": 4
      "Increase/Decrease Level": 5
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 6 Action (Short)"
    id: input6_short_action
    address: 837
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
      "Decrease Level": 3
      "Increase Level": 4
      "Increase/Decrease Level": 5

  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 1 Action (Long)"
    id: input1_long_action
    address: 848
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
      "Decrease Level": 3
      "Increase Level": 4
      "Increase/Decrease Level": 5
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 2 Action (Long)"
    id: input2_long_action
    address: 849
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
      "Decrease Level": 3
      "Increase Level": 4
      "Increase/Decrease Level": 5
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 3 Action (Long)"
    id: input3_long_action
    address: 850
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
      "Decrease Level": 3
      "Increase Level": 4
      "Increase/Decrease Level": 5
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 4 Action (Long)"
    id: input4_long_action
    address: 851
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
      "Decrease Level": 3
      "Increase Level": 4
      "Increase/Decrease Level": 5
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 5 Action (Long)"
    id: input5_long_action
    address: 852
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
      "Decrease Level": 3
      "Increase Level": 4
      "Increase/Decrease Level": 5
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 6 Action (Long)"
    id: input6_long_action
    address: 853
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
      "Decrease Level": 3
      "Increase Level": 4
      "Increase/Decrease Level": 5

  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 1 Action (Double)"
    id: input1_double_action
    address: 864
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
      "Decrease Level": 3
      "Increase Level": 4
      "Increase/Decrease Level": 5
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 2 Action (Double)"
    id: input2_double_action
    address: 865
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
      "Decrease Level": 3
      "Increase Level": 4
      "Increase/Decrease Level": 5
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 3 Action (Double)"
    id: input3_double_action
    address: 866
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
      "Decrease Level": 3
      "Increase Level": 4
      "Increase/Decrease Level": 5
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 4 Action (Double)"
    id: input4_double_action
    address: 867
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
      "Decrease Level": 3
      "Increase Level": 4
      "Increase/Decrease Level": 5
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 5 Action (Double)"
    id: input5_double_action
    address: 868
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
      "Decrease Level": 3
      "Increase Level": 4
      "Increase/Decrease Level": 5
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 6 Action (Double)"
    id: input6_double_action
    address: 869
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
      "Decrease Level": 3
      "Increase Level": 4
      "Increase/Decrease Level": 5

  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 1 Action (Short+Long)"
    id: input1_short_long_action
    address: 880
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
      "Decrease Level": 3
      "Increase Level": 4
      "Increase/Decrease Level": 5
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 2 Action (Short+Long)"
    id: input2_short_long_action
    address: 881
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
      "Decrease Level": 3
      "Increase Level": 4
      "Increase/Decrease Level": 5
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 3 Action (Short+Long)"
    id: input3_short_long_action
    address: 882
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
      "Decrease Level": 3
      "Increase Level": 4
      "Increase/Decrease Level": 5
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 4 Action (Short+Long)"
    id: input4_short_long_action
    address: 883
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
      "Decrease Level": 3
      "Increase Level": 4
      "Increase/Decrease Level": 5
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 5 Action (Short+Long)"
    id: input5_short_long_action
    address: 884
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
      "Decrease Level": 3
      "Increase Level": 4
      "Increase/Decrease Level": 5
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 6 Action (Short+Long)"
    id: input6_short_long_action
    address: 885
    optionsmap:
      "Turn OFF": 0
      "Turn ON": 1
      "Toggle State": 2
      "Decrease Level": 3
      "Increase Level": 4
      "Increase/Decrease Level": 5

  # Short/Long/Double outputs selection (which output to control)
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 1 Output (Short)"
    id: input1_short_output
    address: 768
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 2 Output (Short)"
    id: input2_short_output
    address: 769
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 3 Output (Short)"
    id: input3_short_output
    address: 770
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 4 Output (Short)"
    id: input4_short_output
    address: 771
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 5 Output (Short)"
    id: input5_short_output
    address: 772
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 6 Output (Short)"
    id: input6_short_output
    address: 773
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100

  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 1 Output (Long)"
    id: input1_long_output
    address: 784
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 2 Output (Long)"
    id: input2_long_output
    address: 785
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 3 Output (Long)"
    id: input3_long_output
    address: 786
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 4 Output (Long)"
    id: input4_long_output
    address: 787
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 5 Output (Long)"
    id: input5_long_output
    address: 788
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 6 Output (Long)"
    id: input6_long_output
    address: 789
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100

  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 1 Output (Double)"
    id: input1_double_output
    address: 800
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 2 Output (Double)"
    id: input2_double_output
    address: 801
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 3 Output (Double)"
    id: input3_double_output
    address: 802
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 4 Output (Double)"
    id: input4_double_output
    address: 803
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 5 Output (Double)"
    id: input5_double_output
    address: 804
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 6 Output (Double)"
    id: input6_double_output
    address: 805
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100

  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 1 Output (Short+Long)"
    id: input1_short_long_output
    address: 816
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 2 Output (Short+Long)"
    id: input2_short_long_output
    address: 817
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 3 Output (Short+Long)"
    id: input3_short_long_output
    address: 818
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 4 Output (Short+Long)"
    id: input4_short_long_output
    address: 819
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 5 Output (Short+Long)"
    id: input5_short_long_output
    address: 820
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Input 6 Output (Short+Long)"
    id: input6_short_long_output
    address: 821
    optionsmap:
      "Ignore": 0
      "Output 1": 1
      "Output 2": 2
      "Output 3": 3
      "All Outputs": 100

# ----------------------
# Binary sensors (status coils + discrete input states)
# ----------------------
binary_sensor:
  # channel status (coils)
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    id: ch1_status
    name: "Канал 1 Статус"
    register_type: coil
    address: 0
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    id: ch2_status
    name: "Канал 2 Статус"
    register_type: coil
    address: 1
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    id: ch3_status
    name: "Канал 3 Статус"
    register_type: coil
    address: 2

  # discrete input states (debounced)
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    address: 0
    register_type: discrete_input
    name: "Input 1 State"
    id: input1_state
    filters:
      - delayed_on_off:
          time_on: ${debounce}
          time_off: ${debounce}
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    address: 1
    register_type: discrete_input
    name: "Input 2 State"
    id: input2_state
    filters:
      - delayed_on_off:
          time_on: ${debounce}
          time_off: ${debounce}
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    address: 2
    register_type: discrete_input
    name: "Input 3 State"
    id: input3_state
    filters:
      - delayed_on_off:
          time_on: ${debounce}
          time_off: ${debounce}
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    address: 3
    register_type: discrete_input
    name: "Input 4 State"
    id: input4_state
    filters:
      - delayed_on_off:
          time_on: ${debounce}
          time_off: ${debounce}
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    address: 4
    register_type: discrete_input
    name: "Input 5 State"
    id: input5_state
    filters:
      - delayed_on_off:
          time_on: ${debounce}
          time_off: ${debounce}
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    address: 5
    register_type: discrete_input
    name: "Input 6 State"
    id: input6_state
    filters:
      - delayed_on_off:
          time_on: ${debounce}
          time_off: ${debounce}

# ----------------------
# Sensors (various readings, brightness reads, power, uptime)
# ----------------------
sensor:
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Температура МК"
    address: 124
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "°C"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Питание модуля (мВ)"
    address: 121
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "mV"
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Питание МК (мВ)"
    address: 123
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "mV"
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Аппаратная защита (флаг)"
    address: 100
    register_type: read
    value_type: U_WORD
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Время работы"
    address: 104
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "s"
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Modbus-адрес"
    address: 128
    register_type: holding
    value_type: U_WORD
    icon: "mdi:ethernet"
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Скорость RS-485"
    address: 110
    register_type: holding
    value_type: U_WORD
    icon: "mdi:speedometer"
    filters:
      - multiply: 100

  # brightness readbacks
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    id: ch1_brightness_read
    name: "Канал 1 Яркость"
    register_type: holding
    address: 0
    value_type: U_WORD
    unit_of_measurement: "%"
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    id: ch2_brightness_read
    name: "Канал 2 Яркость"
    register_type: holding
    address: 1
    value_type: U_WORD
    unit_of_measurement: "%"
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    id: ch3_brightness_read
    name: "Канал 3 Яркость"
    register_type: holding
    address: 2
    value_type: U_WORD
    unit_of_measurement: "%"

# ----------------------
# Text sensors
# ----------------------
text_sensor:
  - platform: modbus_controller
    modbus_controller_id: wb_mdm3
    name: "Модель устройства"
    address: 200
    register_type: read
    register_count: 6
    lambda: |-
      return std::string(data.begin(), data.end());

# End of combined config
