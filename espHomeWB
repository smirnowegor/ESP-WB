version: "3.8"

services:
  # Одноразовый init: создаст папки и выставит права в /mnt/data/udobnidom
  setup_esphome:
    image: alpine:3.18
    container_name: setup_esphome
    restart: "no"
    network_mode: host
    volumes:
      - /mnt/data:/mnt/data
    command: /bin/sh -c "\
      set -eux; \
      mkdir -p /mnt/data/udobnidom/esphome/{config,build,cache,data,tmp,.platformio}; \
      mkdir -p /mnt/data/udobnidom/esphome2wb; \
      rm -rf /mnt/data/udobnidom/esphome/.platformio/packages/* || true; \
      chown -R 0:0 /mnt/data/udobnidom/esphome /mnt/data/udobnidom/esphome2wb || true; \
      chmod -R 0777 /mnt/data/udobnidom/esphome /mnt/data/udobnidom/esphome2wb || true; \
      echo done > /mnt/data/udobnidom/esphome/.init_done; \
      exit 0"

  # ESPHome container — все временные каталоги и .platformio на /mnt/data
  esphome:
    container_name: esphome
    image: ghcr.io/esphome/esphome:stable
    restart: unless-stopped
    network_mode: host
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
      - SYS_TIME
      - SYS_PTRACE
      - DAC_OVERRIDE
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

    devices:
      - "/dev:/dev"                # полный доступ к устройствам хоста (при желании заменить конкретными tty)
      - "/dev/ttyUSB0:/dev/ttyUSB0"
      - "/dev/ttyACM0:/dev/ttyACM0"

    volumes:
      - /mnt/data/udobnidom/esphome/config:/config
      - /mnt/data/udobnidom/esphome/build:/build
      - /mnt/data/udobnidom/esphome/cache:/cache
      - /mnt/data/udobnidom/esphome/data:/data
      - /mnt/data/udobnidom/esphome/tmp:/tmp
      - /mnt/data/udobnidom/esphome/.platformio:/root/.platformio
      - /etc/localtime:/etc/localtime:ro

    environment:
      - ESPHOME_BUILD_PATH=/build
      - ESPHOME_DATA_DIR=/data
      - PLATFORMIO_CORE_DIR=/root/.platformio
      - PIP_CACHE_DIR=/cache/pip
      - PLATFORMIO_DISABLE_PROGRESSBAR=true
      - MQTT_BROKER=localhost
      - MQTT_PREFIX=esphome/${name}

    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc: 65535

    healthcheck:
      test: ["CMD-SHELL", "esphome version || exit 1"]
      interval: 1m
      timeout: 10s
      retries: 3

    depends_on:
      - setup_esphome

  # Конвертер MQTT -> виртуальные устройства Wiren Board (esphome2wb)
  esphome2wb:
    container_name: esphome2wb
    image: node:18-slim
    restart: unless-stopped
    network_mode: host
    working_dir: /usr/src/app
    volumes:
      - /mnt/data/udobnidom/esphome2wb:/usr/src/app
    # При старте установит зависимости, если их нет, затем запустит скрипт
    command: /bin/sh -c "if [ ! -d node_modules ]; then npm ci --only=production || npm i --production; fi && node esphome2wb.js"
    depends_on:
      - setup_esphome
      - esphome
    environment:
      - MQTT_BROKER=localhost
      - MQTT_PORT=1883
