version: "3.8"

services:
  esphome:
    image: ghcr.io/esphome/esphome:stable
    container_name: esphome
    restart: unless-stopped

    # Сеть и привилегии
    network_mode: "host"
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
      - SYS_TIME
      - SYS_PTRACE
      - DAC_OVERRIDE
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

    # Доступ к физическим устройствам (serial/usb и т.д.)
    # Это даёт контейнеру доступ ко всем устройствам хоста. При желании можно заменить /dev:/dev
    # на конкретные устройства, например: - "/dev/ttyUSB0:/dev/ttyUSB0"
    devices:
      - "/dev:/dev"
      - "/dev/ttyUSB0:/dev/ttyUSB0"
      - "/dev/ttyACM0:/dev/ttyACM0"

    # Персистентность и перенаправление временных/кэш директорий на большой раздел
    volumes:
      - /mnt/data/docker/esphome/config:/config
      - /mnt/data/docker/esphome/build:/build
      - /mnt/data/docker/esphome/cache:/cache
      - /mnt/data/docker/esphome/data:/data
      - /mnt/data/docker/esphome/tmp:/tmp
      - /etc/localtime:/etc/localtime:ro

    # Порты (при network_mode: host не используются, но оставлены для наглядности)
    ports:
      - "6052:6052"
      - "6053:6053"
      - "80:80"
      - "443:443"
      - "8080:8080"
      - "3232:3232"

    environment:
      - USERNAME=admin
      - PASSWORD=very-secret-password
      - ESPHOME_BUILD_PATH=/build
      - ESPHOME_DATA_DIR=/data
      - PLATFORMIO_CORE_DIR=/cache/pio
      - PIP_CACHE_DIR=/cache/pip
      - PLATFORMIO_DISABLE_PROGRESSBAR=true

    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc: 65535

    healthcheck:
      test: ["CMD-SHELL", "esphome version || exit 1"]
      interval: 1m
      timeout: 10s
      retries: 3
